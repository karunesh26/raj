webpackJsonp([10],{297:function(e,t,s){"use strict";e.exports=function(e){var t=s(2),i=(s(1),s(46)),n=s(43),o=s(179),a=o.getUserRole()===Enums.UserRole.NormalUser;return a?{start:function(e){o.subscribeEvent("MailWebclient::ConstructView::before",function(o){if("CMailView"===o.Name){var a=i.computed(function(){return o.MailCache.folderList().currentFolder()}),r=s(298),u=new r(o.MailCache,t.bind(o.View.routeMessageView,o.View));a.subscribe(function(){var t=a()?a().fullName():"";"Notes"===t?(o.View.setCustomPreviewPane("MailNotesPlugin",u),o.View.setCustomBigButton("MailNotesPlugin",function(){e.run("MailWebclient","setCustomRouting",[t,1,"","","","create-note"])},n.i18n("MAILNOTESPLUGIN/ACTION_NEW_NOTE")),o.View.resetDisabledTools("MailNotesPlugin",["spam","move","mark"])):(o.View.removeCustomPreviewPane("MailNotesPlugin"),o.View.removeCustomBigButton("MailNotesPlugin"),o.View.resetDisabledTools("MailNotesPlugin",[]))})}}),o.subscribeEvent("MailWebclient::ConstructView::after",function(e){if("CMessageListView"===e.Name&&e.MailCache){var t=i.computed(function(){return e.MailCache.folderList().currentFolder()});t.subscribe(function(){var s=t()?t().fullName():"";"Notes"===s?e.View.customMessageItemViewTemplate("MailNotesPlugin_MessageItemView"):e.View.customMessageItemViewTemplate("")})}}),o.subscribeEvent("MailWebclient::MessageDblClick::before",t.bind(function(e){e.Message&&"Notes"===e.Message.folder()&&(e.Cancel=!0)},this))}}:null}},298:function(e,t,s){"use strict";function i(e){if("string"!=typeof e)return"";var t=function(e,t,s){var i=t.replace(/(\w{3,4}:\/\/)(.*)/,"$2");return t===s||i===s?t:s+" ("+t+")"};return e.replace(/\r\n/g," ").replace(/\n/g," ").replace(/<style[^>]*>[^<]*<\/style>/gi,"\n").replace(/<br *\/{0,1}>/gi,"\n").replace(/<\/p>/gi,"\n").replace(/(<\/div>)*$/,"").replace(/<(\/div>)+/gi,"\n").replace(/<a [^>]*href="([^"]*?)"[^>]*>(.*?)<\/a>/gi,t).replace(/<[^>]*>/g,"").replace(/&nbsp;/g," ").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&amp;/g,"&").replace(/&quot;/g,'"')}function n(e,t){M=e,this.fRouteMessageView=t,this.currentMessage=M.currentMessage,this.currentMessage.subscribe(this.onCurrentMessageSubscribe,this),this.messageText=r.observable(""),this.messageText.focused=r.observable(!1),r.computed(function(){this.messageText(),this.messageText.focused(!0)},this).extend({throttle:5}),this.sMessageUid="",this.sMessageText="",this.isLoading=r.observable(!1),this.isSaving=r.observable(!1),this.createMode=r.observable(!1),this.saveButtonText=r.computed(function(){return this.isSaving()?l.i18n("COREWEBCLIENT/ACTION_SAVE_IN_PROGRESS"):l.i18n("COREWEBCLIENT/ACTION_SAVE")},this)}var o=s(2),a=s(1),r=s(46),u=s(184),c=s(185),l=s(43),g=s(179),d=s(189),h=s(181),N=s(42),M=null;n.prototype.ViewTemplate="MailNotesPlugin_MessagePaneView",n.prototype.ViewConstructorName="CMessagePaneView",n.prototype.getSubjectFromText=function(e){var t=e.split(/\r\n|\n/i),s=o.find(t,function(e){return""!==a.trim(e)});return s=a.trim(s),s.length>50&&(s=s.substring(0,50)),s},n.prototype.onCurrentMessageSubscribe=function(){var e=this.currentMessage(),t={AccountId:M.currentAccountId(),FolderFullName:"Notes",MessageUid:this.sMessageUid,Text:this.messageText().replace(/\n/g,"<br />").replace(/\r\n/g,"<br />"),Subject:this.getSubjectFromText(this.messageText())};if(e||this.sMessageText===this.messageText()||u.showPopup(c,[l.i18n("MAILNOTESPLUGIN/CONFIRM_NOTE_NOT_SAVED"),o.bind(function(e){if(e){var s=M.getFolderByFullName(M.currentAccountId(),"Notes");s.markDeletedByUids([t.MessageUid]),M.excludeDeletedMessages(),this.sMessageText=this.messageText(),d.send("MailNotesPlugin","SaveNote",t,function(e){e.Result||h.showErrorByCode(e,l.i18n("MAILNOTESPLUGIN/ERROR_NOTE_SAVING")),M.executeCheckMail(!0)},this)}},this),"",l.i18n("MAILNOTESPLUGIN/ACTION_SAVE"),l.i18n("MAILNOTESPLUGIN/ACTION_DISCARD")]),e){if(e.isPlain()?this.messageText(e.textRaw()):this.messageText(i(a(e.text()).html())),this.sMessageUid=e.uid(),this.sMessageText=this.messageText(),this.isLoading(""!==e.uid()&&!e.completelyFilled()),!e.completelyFilled())var s=e.completelyFilled.subscribe(function(){this.onCurrentMessageSubscribe(),s.dispose()},this);this.isSaving(!1)}else this.sMessageUid="",this.sMessageText="",this.messageText("")},n.prototype.onBind=function(e){N.run("SessionTimeoutWeblient","registerFunction",[o.bind(function(){this.saveNote()},this)]),a(document).on("keydown",a.proxy(function(e){e.ctrlKey&&e.keyCode===Enums.Key.s&&(e.preventDefault(),this.saveNote())},this)),g.subscribeEvent("CoreWebclient::SelectListItem::before",o.bind(function(e){var t=e.Item,s={AccountId:M.currentAccountId(),FolderFullName:"Notes",MessageUid:this.sMessageUid,Text:this.messageText().replace(/\n/g,"<br />").replace(/\r\n/g,"<br />"),Subject:this.getSubjectFromText(this.messageText())};t&&"CMessageModel"===t.constructor.name&&this.sMessageUid!==t.uid()&&this.sMessageText!==this.messageText()&&(e.Cancel=!0,u.showPopup(c,[l.i18n("MAILNOTESPLUGIN/CONFIRM_NOTE_NOT_SAVED"),o.bind(function(t){if(t){var i=M.getFolderByFullName(M.currentAccountId(),"Notes");i.markDeletedByUids([s.MessageUid]),M.excludeDeletedMessages(),this.sMessageText=this.messageText(),d.send("MailNotesPlugin","SaveNote",s,function(e){e.Result||h.showErrorByCode(e,l.i18n("MAILNOTESPLUGIN/ERROR_NOTE_SAVING")),M.executeCheckMail(!0)},this)}o.isFunction(e.ProceedSelectionHandler)&&e.ProceedSelectionHandler()},this),"",l.i18n("MAILNOTESPLUGIN/ACTION_SAVE"),l.i18n("MAILNOTESPLUGIN/ACTION_DISCARD")]))},this))},n.prototype.onRoute=function(e,t){M.setCurrentMessage(t.Uid,t.Folder),"create-note"===t.Custom?(this.messageText(""),this.createMode(!0)):this.createMode(!1),this.isSaving(!1)},n.prototype.onHide=function(){this.sMessageText!==this.messageText()&&u.showPopup(c,[l.i18n("MAILNOTESPLUGIN/CONFIRM_NOTE_NOT_SAVED"),o.bind(function(e){e&&this.saveEditedNote()},this),"",l.i18n("MAILNOTESPLUGIN/ACTION_SAVE"),l.i18n("MAILNOTESPLUGIN/ACTION_DISCARD")])},n.prototype.saveNote=function(){this.createMode()?this.saveNewNote():this.saveEditedNote()},n.prototype.saveNewNote=function(){var e=M.getCurrentFolder(),t={AccountId:M.currentAccountId(),FolderFullName:e.fullName(),Text:this.messageText().replace(/\n/g,"<br />").replace(/\r\n/g,"<br />"),Subject:this.getSubjectFromText(this.messageText())};this.isSaving(!0),this.sMessageText=this.messageText(),d.send("MailNotesPlugin","SaveNote",t,function(e){if(this.isSaving(!1),e.Result)var s=M.messagesLoading.subscribe(function(){M.messagesLoading()||(this.fRouteMessageView(t.FolderFullName,e.Result),s.dispose())},this);else h.showErrorByCode(e,l.i18n("MAILNOTESPLUGIN/ERROR_NOTE_SAVING"));M.executeCheckMail(!0)},this)},n.prototype.saveEditedNote=function(e){if(e||(e=this.currentMessage()),e){var t={AccountId:M.currentAccountId(),FolderFullName:e.folder(),MessageUid:e.uid(),Text:this.messageText().replace(/\n/g,"<br />").replace(/\r\n/g,"<br />"),Subject:this.getSubjectFromText(this.messageText())},s=M.getFolderByFullName(M.currentAccountId(),e.folder());s.markDeletedByUids([e.uid()]),M.excludeDeletedMessages(),this.isSaving(!0),this.sMessageText=this.messageText(),d.send("MailNotesPlugin","SaveNote",t,function(e){if(this.isSaving(!1),e.Result)var s=M.messagesLoading.subscribe(function(){M.messagesLoading()||(this.fRouteMessageView(t.FolderFullName,e.Result),s.dispose())},this);else h.showErrorByCode(e,l.i18n("MAILNOTESPLUGIN/ERROR_NOTE_SAVING"));M.executeCheckMail(!0)},this)}},n.prototype.cancel=function(){this.sMessageText=this.messageText(),N.run("MailWebclient","setCustomRouting",["Notes",1,"","","",""])},e.exports=n}});